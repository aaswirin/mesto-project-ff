(()=>{"use strict";var e={idTemplate:"#card-template",classPlacesList:".places__list",classPlacesItem:".places__item",classCardImage:".card__image",classCardTitle:".card__title",classCardDeleteButton:".card__delete-button",classListItem:"li.places__item",classWindowPopup:".popup__content",classWindowOpen:".popup_is-opened",classWindowOpenNotDot:"popup_is-opened",classWindowAnimatedNotDot:"popup_is-animated",classElementClose:".popup__close",classForm:".popup__form",classInput:".popup__input",classSubmitButton:".popup__button",classSubmitLabel:".popup__button-label",classSpinner:".popup__spinner",classSpinnerVisible:"popup__spinner-visible",classNetError:".popup__net-error",classNetErrorShow:"popup__net-error-show",classNetErrorClose:".popup__net-error-close",classNetErrorMessage:".popup__net-error-message",timeShowNetError:10,keysClose:["Escape"],classButtonEditAvatar:".profile__image",classWindowEditAvatar:".popup_edit-avatar",bindAvatar:[{name:"link",nameForm:"link-avatar"}],classButtonEditProfile:".profile__edit-button",classWindowEditProfile:".popup_type_edit",bindProfile:[{classPage:".profile__title",nameAPI:"name",nameForm:"name",typeElement:"text"},{classPage:".profile__description",nameAPI:"about",nameForm:"description",typeElement:"text"},{classPage:".profile__image",nameAPI:"avatar",nameForm:"",typeElement:"image"}],classButtonAddCard:".profile__add-button",classWindowAddCard:".popup_type_new-card",bindCard:[{name:"name",nameForm:"place-name"},{name:"link",nameForm:"link"}],classWindowViewImage:".popup_type_image",classViewImage:".popup__image",classViewCaption:".popup__caption",classWindowMessage:".popup_message",classCaptionMessage:".popup__title",classTextMessage:".popup__text",classMarkerCall:".popup__marker-call",classLikeButton:".card__like-button",classLikeYesNotDot:"card__like-button_is-active",classLikesCount:".card__likes-count",classLikesTooltip:".card__tooltip",classItemTooltip:"card__tooltip-item",classTitleTooltip:"card__tooltip-title",classImageTooltip:"card__tooltip-image",classTextTooltip:"card__tooltip-text",classMarginTooltip:"card__tooltip-item-margin",countLikeInTooltip:5,classErrorValidation:"popup__input-error",classValidationContainer:"popup__input-error-container-active",classButtonInActive:"popup__button-inactive",apiIdUser:"",apiURL:"https://nomoreparties.co/v1/",apiIdGroup:"wff-cohort-35",apiToken:"1e636933-64cf-4fb7-82cc-a4047b92f087",methodProfile:"users/me",methodCard:"cards",methodLike:"cards/likes",methodAvatar:"users/me/avatar"};function t(e,t,n){var a=t.likes.length;e.querySelector(n.classLikesCount).textContent=a.toString();for(var o=e.querySelector(n.classLikesTooltip),s=o.lastElementChild;s;)o.removeChild(s),s=o.lastElementChild;var r=document.createElement("li");r.classList.add(n.classTitleTooltip),r.textContent="Владелец:",o.append(r),(r=document.createElement("li")).classList.add(n.classItemTooltip,n.classMarginTooltip);var c=document.createElement("img");c.classList.add(n.classImageTooltip),c.setAttribute("src",t.owner.avatar),c.setAttribute("alt","Владелец карты: ".concat(t.owner.name)),r.append(c);var l=document.createElement("span");l.classList.add(n.classTextTooltip),l.textContent=t.owner.name,r.setAttribute("margin-bottom","10px"),r.append(l),o.append(r);var i=document.createElement("li");if(i.classList.add(n.classTitleTooltip),0===a)i.textContent="Увы, лайков нет...",o.append(i);else{i.textContent="Лайки этого места:",o.append(i);var u=0,d=0;if(t.likes.forEach((function(t){if(u++,t._id===n.apiIdUser&&e.querySelector(n.classLikeButton).classList.add(n.classLikeYesNotDot),u<=n.countLikeInTooltip){var a=document.createElement("li");a.classList.add(n.classItemTooltip);var s=document.createElement("img");s.classList.add(n.classImageTooltip),s.setAttribute("src",t.avatar),s.setAttribute("alt","Установил лайк: ".concat(t.name)),a.append(s);var r=document.createElement("span");r.classList.add(n.classTextTooltip),r.textContent=t.name,a.append(r),o.append(a)}else d++})),0!==d){var m=document.createElement("li");m.textContent="...и ещё ".concat(d),o.append(m)}}}function n(e,n,a,o){if(null!==e.target){var s,r,c=e.target.closest(o.classPlacesItem),l=e.target,i={id:n,elementCard:c,elementLike:l};e.target.classList.contains(o.classLikeYesNotDot)?(s=a.deleteLike(i,o),r="снятии"):(s=a.setLike(i,o),r="установке"),s.then((function(e){return e.ok?e.json():Promise.reject("Ошибка при ".concat(r," лайка:  ").concat(e.status,", ").concat(e.statusText))})).then((function(e){l.parentElement.querySelector(o.classLikesCount).textContent=e.likes.length.toString(),function(e,t){e.classList.toggle(t.classLikeYesNotDot)}(l,o),t(c,e,o)})).catch((function(e){a.showMessage("Ошибка при ".concat(r," лайка"),e,"Понятно")}))}}function a(e){null!==e.elementPlace&&e.elementPlace.remove()}function o(e,t,n){e.classList.add(t.classWindowAnimatedNotDot),e.querySelector(t.classElementClose).addEventListener("click",(function(){return n.close(e,n.close)})),e.addEventListener("mouseup",(function(t){return n.closeUp(t,e,n.closeUp)}));var a=e.querySelector(t.classNetError);null!==a&&a.querySelector(t.classNetErrorClose).addEventListener("click",(function(){a.classList.remove(t.classNetErrorShow)}))}function s(e,t,n){e.classList.add(t.classWindowOpenNotDot),document.addEventListener("keydown",n)}function r(e,t,n){e.classList.remove(t.classWindowOpenNotDot),document.removeEventListener("keydown",n)}function c(e,t,n){var a=Array.from(e.querySelectorAll(n.classInput));a.forEach((function(e){l(e,n)})),i(a,t,n),t.querySelector(n.classSubmitLabel).textContent="Сохранить",t.querySelector(n.classSpinner).classList.remove(n.classSpinnerVisible)}function l(e,t){var n=document.querySelector(".popup__input-error-".concat(e.id));e.classList.remove(t.classErrorValidation),n.textContent="",n.classList.remove(t.classValidationContainer)}function i(e,t,n){u(t,function(e){return e.some((function(e){return!e.validity.valid}))}(e),n)}function u(e,t,n){e.disabled=t,t?e.classList.add(n.classButtonInActive):e.classList.remove(n.classButtonInActive)}function d(e,t){var n="".concat(t.apiURL).concat(t.apiIdGroup,"/").concat(e.nameMethod),a={method:e.method,headers:{authorization:t.apiToken}};return null!==e.id&&(n+="/".concat(e.id)),null!==e.body&&(a.headers["Content-Type"]="application/json",a.body=JSON.stringify(e.body)),fetch(n,a)}function m(e,t){return d({nameMethod:t.methodCard,method:"DELETE",body:null,id:e.id},t)}function p(e,t){return d({nameMethod:t.methodLike,method:"PUT",body:null,id:e.id},t)}function f(e,t){return d({nameMethod:t.methodLike,method:"DELETE",body:null,id:e.id},t)}var v=document.querySelector(e.idTemplate).content,_=document.querySelector(e.classPlacesList),S=document.querySelector(e.classWindowEditAvatar),y=S.querySelector(e.classForm),L=y.querySelector(e.classSubmitButton),b=document.querySelector(e.classWindowEditProfile),E=b.querySelector(e.classForm),h=E.querySelector(e.classSubmitButton),C=document.querySelector(e.classWindowAddCard),k=C.querySelector(e.classForm),g=k.querySelector(e.classSubmitButton),q=document.querySelector(e.classWindowViewImage),T=q.querySelector(e.classViewImage),P=document.querySelector(e.classWindowMessage),w=P.querySelector(e.classCaptionMessage),x=P.querySelector(e.classTextMessage),A=P.querySelector(e.classSubmitButton);function I(t){var n=t.querySelector(e.classForm);return null===n?"":n.getAttribute("name")}function M(t){var n=I(t);if(""!==n){document.forms[n].reset();var a=t.querySelector(e.classNetError);null!==a&&B(a)}}function N(e,t){t.forEach((function(t){var n=document.querySelector(t.classPage);if(null!==n){var a=e[t.nameAPI];"text"===t.typeElement?n.textContent=a:"image"===t.typeElement&&n.setAttribute("style","background-image: url(".concat(a,");"))}}))}function V(t,n){var a=t.querySelector(e.classNetError);a.classList.add(e.classNetErrorShow),t.querySelector(e.classNetErrorMessage).textContent=n,setTimeout((function(){B(a)}),1e3*e.timeShowNetError)}function B(t){t.classList.remove(e.classNetErrorShow)}function W(t,n){r(t,e,n),t===P&&A.classList.remove(e.classMarkerCall),M(t)}function D(t){if(function(e,t){return-1!==t.keysClose.findIndex((function(t){return t===e.key}))}(t,e)){var n=document.querySelector(e.classWindowOpen);null!==n&&W(n,D)}}document.querySelector(e.classButtonEditAvatar).addEventListener("click",(function(){c(y,L,e),u(L,!0,e),s(S,e,D)})),document.querySelector(e.classButtonEditProfile).addEventListener("click",(function(){var t,n,a;t=b,n=e.bindProfile,""!==(a=I(t))&&n.forEach((function(e){if(""!==e.nameForm){var t=document.querySelector(e.classPage);null!==t&&(document.forms[a].elements[e.nameForm].value=t.textContent)}})),c(b,h,e),u(h,!1,e),s(b,e,D)})),document.querySelector(e.classButtonAddCard).addEventListener("click",(function(){c(k,g,e),u(g,!0,e),s(C,e,D)}));var F={functionCall:null,callback:null,data:{}};function j(t,n){F.functionCall=m,F.callback=a,F.messageError="Ошибка при удалении карты",F.data.id=n,F.data.elementPlace=t,A.classList.add(e.classMarkerCall),O("Вы уверены?","","Да")}function U(t){!function(t,n){T.setAttribute("src",n.getAttribute("src")),T.setAttribute("alt",n.getAttribute("alt"));var a=n.closest(e.classListItem);null!==a&&(t.querySelector(e.classViewCaption).textContent=a.querySelector(e.classCardTitle).textContent)}(q,t.target),s(q,e,D)}function O(t,n,a){w.textContent=t,x.textContent=n,A.textContent=a,s(P,e,D)}function G(a,o){var s={onDeleteCard:j,onOpenPreview:U,onLikeCard:n,deleteLike:f,setLike:p,showMessage:O};a.forEach((function(n){var a=function(e,n,a,o){var s=n.querySelector(a.classPlacesItem).cloneNode(!0),r=s.querySelector(a.classCardImage);r.setAttribute("src",e.link),r.setAttribute("alt","Место на картинке: "+e.name),r.addEventListener("click",(function(e){return o.onOpenPreview(e)})),s.querySelector(a.classCardTitle).textContent=e.name;var c=s.querySelector(a.classCardDeleteButton);return e.owner._id===a.apiIdUser?c.addEventListener("click",(function(){return o.onDeleteCard(s,e._id)})):c.remove(),s.querySelector(a.classLikeButton).addEventListener("click",(function(t){return o.onLikeCard(t,e._id,o,a)})),t(s,e,a),s}(n,v,e,s);o?_.prepend(a):_.append(a)}))}var Y={close:W,closeUp:function(t,n,a){(function(e,t){return null===e.target.closest(t.classWindowPopup)})(t,e)&&W(n,a)}};(function(e){return Promise.all([d({nameMethod:e.methodProfile,method:"GET",body:null,id:null},e),d({nameMethod:e.methodCard,method:"GET",body:null,id:null},e)])})(e).then((function(e){if(!e[0].ok||!e[1].ok){var t,n=0==(t=e[0].ok?1:0)?"профиля":"карт";return Promise.reject("Ошибка при загрузке ".concat(n,":  ").concat(e[t].status,", ").concat(e[t].statusText))}return e})).then((function(e){return Promise.all(e.map((function(e){return e.json()})))})).then((function(t){e.apiIdUser=t[0]._id,N(t[0],e.bindProfile),G(t[1],!1)})).catch((function(e){O("Ошибка при загрузке",e,"Понятно")})),E.addEventListener("submit",(function(t){t.preventDefault();var n=I(b);if(""!==n){var a={};e.bindProfile.forEach((function(e){""!==e.nameAPI&&""!==e.nameForm&&(a[e.nameAPI]=document.forms[n].elements[e.nameForm].value)})),h.querySelector(e.classSubmitLabel).textContent="Сохранение...",h.querySelector(e.classSpinner).classList.add(e.classSpinnerVisible),function(e,t){return d({nameMethod:t.methodProfile,method:"PATCH",body:{name:e.name,about:e.about},id:null},t)}(a,e).then((function(e){return e.ok?e.json():Promise.reject("Ошибка при записи профиля:  ".concat(e.status,", ").concat(e.statusText))})).then((function(t){N(t,e.bindProfile),r(b,e,D),M(b)})).catch((function(e){V(b,e)})).finally((function(){h.querySelector(e.classSubmitLabel).textContent="Сохранить",h.querySelector(e.classSpinner).classList.remove(e.classSpinnerVisible)}))}})),o(b,e,Y),k.addEventListener("submit",(function(t){t.preventDefault();var n=I(C);if(""!==n){var a={};e.bindCard.forEach((function(e){a[e.name]=document.forms[n].elements[e.nameForm].value})),g.querySelector(e.classSubmitLabel).textContent="Сохранение...",g.querySelector(e.classSpinner).classList.add(e.classSpinnerVisible),function(e,t){return d({nameMethod:t.methodCard,method:"POST",body:{name:e.name,link:e.link},id:null},t)}(a,e).then((function(e){return e.ok?e.json():Promise.reject("Ошибка при записи новой карты:  ".concat(e.status,", ").concat(e.statusText))})).then((function(t){!function(e){""!==I(C)&&G(e,!0)}([t]),r(C,e,D),M(C)})).catch((function(e){V(C,e)})).finally((function(){g.querySelector(e.classSubmitLabel).textContent="Сохранить",g.querySelector(e.classSpinner).classList.remove(e.classSpinnerVisible)}))}})),o(C,e,Y),o(q,e,Y),y.addEventListener("submit",(function(t){t.preventDefault();var n=I(S);if(""!==n){var a={};e.bindAvatar.forEach((function(e){a[e.name]=document.forms[n].elements[e.nameForm].value})),L.querySelector(e.classSubmitLabel).textContent="Сохранение...",L.querySelector(e.classSpinner).classList.add(e.classSpinnerVisible),function(e,t){return d({nameMethod:t.methodAvatar,method:"PATCH",body:{avatar:e.link},id:null},t)}(a,e).then((function(e){return e.ok?e.json():Promise.reject("Ошибка при записи аватара:  ".concat(e.status,", ").concat(e.statusText))})).then((function(t){N(t,e.bindProfile),r(S,e,D),M(S)})).catch((function(e){V(S,e)})).finally((function(){L.querySelector(e.classSubmitLabel).textContent="Сохранить",L.querySelector(e.classSpinner).classList.remove(e.classSpinnerVisible)}))}})),o(S,e,Y),A.addEventListener("click",(function(){A.classList.contains(e.classMarkerCall)&&F.functionCall(F.data,e).then((function(e){if(!e.ok)return Promise.reject("".concat(F.messageError,":  ").concat(e.status,", ").concat(e.statusText));F.callback(F.data)})).catch((function(e){O(F.messageError,e,"Понятно")})),W(P,D)})),o(P,e,Y),function(e){Array.from(document.querySelectorAll(e.classForm)).forEach((function(t){var n=t.querySelector(e.classSubmitButton);!function(e,t,n){var a=Array.from(e.querySelectorAll(n.classInput));a.forEach((function(e){e.addEventListener("input",(function(){!function(e,t,n,a,o){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?l(t,o):function(e,t,n){var a=document.querySelector(".popup__input-error-".concat(e.id));e.classList.add(n.classErrorValidation),a.textContent=t,a.classList.add(n.classValidationContainer)}(t,t.validationMessage,o),i(n,a,o)}(0,e,a,t,n)}))}))}(t,n,e)}))}(e)})();
//# sourceMappingURL=main.js.map